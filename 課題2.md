# 画面遷移が行われるケース (戻る/進む、リロード、URL 直打ち、閉じるなど) の制御について

## 目的

ブラウザの操作で画面遷移が行われるケースがある。  
※ 戻る/進む、リロード、URL 直打ち、閉じるなど。

現行では、ログアウトやトランザクション処理都合、これら操作に制限がかけられていることから、これらの制御を行うことができるかを検証したい。  
また、別軸で制御を行うべきかどうかについても検討したい。

<br><br>

## 調査

[動作検証コード](https://github.com/visualpaper/work-km-ui-window-public/tree/main/app/case2)

* router.push で遷移されていない (window.open などで遷移された) ページ
  -> 進む/戻る、リロード、URL 直打ち、閉じる、いずれも制御可能  
  ※ 進む/戻るでは、なんらか画面上の操作を一度行わなければならない点に注意。

* router.push で遷移されたページ
  -> リロード、URL 直打ち、閉じるは制御可能  
  -> 進む/戻るは制御不可能  

<br>

挙動確認をしてみたところ、上記のような挙動が確認できた。  
NextJS で提供されている[ルーティング機能](https://nextjs.org/docs/pages/building-your-application/routing/linking-and-navigating)は `<Link>` または `router` があるのだが、  
これで画面遷移を行った画面間では、戻る/進むが `beforeunload` でも制御できない。

この挙動自体は NextJS 公式の [discussions](https://github.com/vercel/next.js/discussions/41934) ページでも議論されており、以下のことがわかった。
* `router` での画面遷移は `window.open` での画面遷移とは別軸で動いている
* そのため `router` に対し EventListener (`routeChangeStart`) を登録し検知し制御すればできる
* が、この EventListener 登録機能が NextJS 14 からは閉じられており、制御ができない
* 2024/5 より[代替案](https://github.com/vercel/next.js/discussions/41934#discussioncomment-8996669)が提示されているようなお話はあるのだが、かなりトリッキーであり、メンションを見る限りやや不評で、導入することで何が起こるかが不透明

<br><br>

## 検討

調査結果より `router` での遷移を行わず、全て window.open などで遷移すればできるように見えるものの、  
そうした場合、layout.tsx での Context を利用した状態管理ができなくなる。  
※ window.open 新ウィンドウで開こうが開かなかろうが結局 URL 直打ちした状態と変わりなく、そうすると状態が複数ページ間で扱えなくなってしまう。  

そもそも、公式が提供している[ルーティング機能](https://nextjs.org/docs/pages/building-your-application/routing/linking-and-navigating)を使わずに画面遷移を行うというのもバットプラクティスだと思われることから、

画面遷移後に状態を確認し不正かどうかの確認は可能であり、進む/戻る以外の遷移制御 (リロード、URL 直打ち、閉じる) はかけられるので、
必要なケースは運用でカバーしつつ、新しいタブ/ウィンドウを開く必要がなければ原則 `router` で遷移するという方向で進めたい。

また、別軸のお話として、layout.tsx で Context を利用した状態管理方法自体が正しいのかを考えたとき、
その方法を例として提示しているものは[ある](https://github.com/ProNextJS/state-management-tutorial/tree/main/04-complete-react-state)ので間違いではないと思っているが、
この方法を用いない方法として、いくらか方法がないわけではない (localStorage やサーバで Session 情報を保持するなど) ので、この制約によって `router` で遷移しなければならないというというお話になるのは良くないとも思っている。

<br><br>

## 案

### 1

* router で画面遷移を行う  
* 戻る/進むに制御をかけない  
  ※ 運用で禁止いただくことが可能であれば打診する。  
* 画面遷移後に状態が不正であれば警告メッセージを表示しメニューなどに遷移する  
  ※ 運用で禁止できる/できないに関わらず、データの不整合などが起きえるような不正な画面遷移が行われた場合、その遷移先画面で状態を確認し警告メッセージを表示する。

メニューでなくとも、業務の開始ページや xxx メニューページなどに飛ばしても OK

#### メリット

* 工数がかからない  

#### デメリット

* 既存の挙動を踏襲できない (可能性がある。全てを知らないので)

<br>

### 2

* router で画面遷移を行わない
  ※ 一律 window.open で遷移する  
* 戻る/進むに制御をかける  
  ※ 別途、なんらかの操作を行った後でないと制御はできないので、利用者への注意喚起は必要になる。  

#### メリット

* なし

#### デメリット

* 既存の挙動を踏襲できない
  ※ window.open で遷移をしている都合上、既存の挙動を画面遷移後に状態が不正であるかどうかの判断ができなくなる  
  ※ そのため、結局のところ既存の挙動の踏襲ができないケースが発生すると思われる

<br><br>

<b> ⇒ 案1 の方針で進めたい。 </b>
